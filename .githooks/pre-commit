#!/usr/bin/env bash

# Pre-commit hook for shared-schedule-app
# This script runs various checks before allowing a commit

set -o errexit
set -o errtrace
set -o nounset
set -o pipefail

echo "ğŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if Docker containers are running
check_container() {
  local container_name=$1
  if ! docker compose ps --status running | grep -q "$container_name"; then
    echo -e "${RED}âœ— Container '$container_name' is not running${NC}"
    echo -e "${YELLOW}Please start the containers with: docker compose up -d${NC}"
    return 1
  fi
  return 0
}

# Function to run command in container
run_in_container() {
  local container_name=$1
  shift
  docker compose exec -T "$container_name" "$@"
}

echo ""
echo "ğŸ“¦ Checking Docker containers..."
check_container "api" || exit 1
check_container "web" || exit 1
echo -e "${GREEN}âœ“ All containers are running${NC}"

# Running API checks
echo ""
echo "ğŸ”§ Running API checks..."
echo "  â†’ Running biome lint check (API)..."
if run_in_container api sh -c "cd /var/www/html/apps/api/app && npm run lint"; then
  echo -e "${GREEN}  âœ“ API lint check passed${NC}"
else
  echo -e "${RED}  âœ— API lint check failed${NC}"
  echo -e "${YELLOW}  Fix issues with: docker compose exec api sh -c 'cd /var/www/html/apps/api/app && npm run format'${NC}"
  exit 1
fi

# Running Prisma schema validation
echo "  â†’ Validating Prisma schema..."
if run_in_container api sh -c "cd /var/www/html/apps/api/app && npm run prisma:validate"; then
  echo -e "${GREEN}  âœ“ Prisma schema is valid${NC}"
else
  echo -e "${RED}  âœ— Prisma schema validation failed${NC}"
  exit 1
fi

# Running Web checks
echo ""
echo "ğŸŒ Running Web checks..."
echo "  â†’ Running biome lint check (Web)..."
if run_in_container web sh -c "cd /var/www/html/apps/web/app && npm run lint"; then
  echo -e "${GREEN}  âœ“ Web lint check passed${NC}"
else
  echo -e "${RED}  âœ— Web lint check failed${NC}"
  echo -e "${YELLOW}  Fix issues with: docker compose exec web sh -c 'cd /var/www/html/apps/web/app && npm run format'${NC}"
  exit 1
fi

# Running type checks
echo ""
echo "ğŸ§ª Running type checks..."
echo "  â†’ Running API type checks..."
if run_in_container api sh -c "cd /var/www/html/apps/api/app && npm run typecheck"; then
  echo -e "${GREEN}  âœ“ API type checks passed${NC}"
else
  echo -e "${RED}  âœ— API type checks failed${NC}"
  exit 1
fi

# Running tests
echo ""
echo "ğŸ§ª Running tests..."
echo "  â†’ Running API tests..."
if run_in_container api sh -c "cd /var/www/html/apps/api/app && npm run test"; then
  echo -e "${GREEN}  âœ“ API tests passed${NC}"
else
  echo -e "${RED}  âœ— API tests failed${NC}"
  exit 1
fi

echo ""
echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo ""

exit 0
